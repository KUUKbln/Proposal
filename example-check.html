<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>SHA-256 Datei-Validator mit Visualisierung</title>
  <style>
    body { font-family: sans-serif; padding: 2em; background: #f4f4f4; }
    #progress { width: 100%; height: 20px; background: #ddd; margin: 1em 0; }
    #bar { height: 100%; width: 0%; background: #4caf50; }
    #results { display: flex; gap: 2em; align-items: start; margin-top: 2em; }
    canvas { image-rendering: pixelated; border: 1px solid #aaa; }
    .hash-box { font-family: monospace; white-space: pre; }
  </style>
</head>
<body>

<!--
  SHA-256 Datei-Validator und Visualisierer
  -----------------------------------------
  Anforderungen:
  - Liest `?url=` und `?hash=` aus der URL-Query
  - L√§dt die Datei per URL mit Fortschrittsanzeige
  - Berechnet SHA-256 der Datei im Browser
  - Zeigt:
    - Vorgabe-Hash (aus ?hash=)
    - Tats√§chlich berechneten Hash
    - Vergleich: ‚úÖ oder ‚ùå
    - Beide Hashes als 16x16 Pixel-Grid (mit 8x Zoom)
  - Bietet die Datei zum Speichern/Download an
  - Kommentiert zur Nachvollziehbarkeit

  Erstellt von ChatGPT am 2025-09-19
-->

<h1>SHA-256 Datei-Validator</h1>

<div id="status">‚è≥ Lade Datei...</div>
<div id="progress"><div id="bar"></div></div>

<div id="results" style="display:none;">
  <div class="hash-box">
    <h2>Vorgegebener Hash</h2>
    <div id="expected-hash"></div>
    <canvas id="expected-canvas" width="128" height="128"></canvas>
  </div>
  <div class="hash-box">
    <h2>Berechneter Hash</h2>
    <div id="computed-hash"></div>
    <canvas id="computed-canvas" width="128" height="128"></canvas>
  </div>
</div>

<a id="download-link" download style="display:none;">üì• Datei speichern</a>

<script>
async function getSHA256(buffer) {
  const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

function drawHashCanvas(hashHex, canvasId) {
  const ctx = document.getElementById(canvasId).getContext("2d");
  const zoom = 8;
  const size = 16;
  const bytes = hashHex.match(/.{2}/g).map(b => parseInt(b, 16));
  const img = ctx.createImageData(size * zoom, size * zoom);

  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      const i = y * size + x;
      const value = bytes[i];
      for (let dy = 0; dy < zoom; dy++) {
        for (let dx = 0; dx < zoom; dx++) {
          const px = ((y * zoom + dy) * size * zoom + (x * zoom + dx)) * 4;
          img.data[px + 0] = value;     // R
          img.data[px + 1] = 255 - value; // G
          img.data[px + 2] = (value % 128) * 2; // B
          img.data[px + 3] = 255;       // A
        }
      }
    }
  }
  ctx.putImageData(img, 0, 0);
}

function getQueryParam(name) {
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

(async () => {
  const url = getQueryParam("url");
  const expectedHash = (getQueryParam("hash") || "").toLowerCase();

  if (!url || !expectedHash) {
    document.getElementById("status").textContent = "‚ö†Ô∏è Bitte ?url= und ?hash= angeben.";
    return;
  }

  const response = await fetch(url);
  const contentLength = response.headers.get("content-length");
  const total = contentLength ? parseInt(contentLength) : 0;
  const reader = response.body.getReader();

  let chunks = [];
  let received = 0;
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    chunks.push(value);
    received += value.length;
    if (total) {
      const percent = Math.floor(received / total * 100);
      document.getElementById("bar").style.width = percent + "%";
    }
  }

  const file = new Blob(chunks);
  const arrayBuffer = await file.arrayBuffer();
  const computedHash = await getSHA256(arrayBuffer);

  // Hash-Vergleich
  const match = computedHash === expectedHash;
  document.getElementById("status").innerHTML = match
    ? "‚úÖ Hash stimmt √ºberein."
    : "‚ùå Hash stimmt NICHT √ºberein.";

  document.getElementById("expected-hash").textContent = expectedHash;
  document.getElementById("computed-hash").textContent = computedHash;

  drawHashCanvas(expectedHash, "expected-canvas");
  drawHashCanvas(computedHash, "computed-canvas");

  document.getElementById("results").style.display = "flex";

  // Download-Link anzeigen
  const blobUrl = URL.createObjectURL(file);
  const dl = document.getElementById("download-link");
  dl.href = blobUrl;
  dl.textContent += ` (${url.split("/").pop()})`;
  dl.style.display = "inline-block";
})();
</script>

</body>
</html>