<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SHA-256 Datei-Validator mit Visualisierung</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1rem;
      line-height: 1.5;
    }
    h1, h2 {
      font-weight: normal;
    }
    #progress {
      width: 100%;
      height: 20px;
      background: #ddd;
      margin: 1em 0;
      border: 1px solid #ccc;
      border-radius: 3px;
      overflow: hidden;
    }
    #bar {
      height: 100%;
      width: 0%;
      background: #000;
      transition: width 0.2s ease;
    }
    #results {
      display: none;
      margin-top: 2em;
      gap: 2em;
      align-items: start;
      display: flex;
    }
    canvas {
      image-rendering: pixelated;
      border: 1px solid #aaa;
      background: #000;
      display: block;
      margin-top: 0.5em;
    }
    .hash-box {
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-word;
      max-width: 45%;
    }
    #download-link {
      display: none;
      margin-top: 1.5em;
      text-decoration: none;
      border: 1px solid #000;
      padding: 0.5em 1em;
      border-radius: 3px;
      cursor: pointer;
      user-select: none;
      color: #000;
    }
    #download-link:hover {
      background: #eee;
    }
  </style>
</head>
<body>

<h1>SHA-256 Datei-Validator</h1>

<div id="status">‚è≥ Bitte geben Sie eine URL und einen Hash an (?url=...&amp;hash=...)</div>
<div id="progress" aria-label="Fortschrittsanzeige"><div id="bar"></div></div>

<div id="results" aria-live="polite" aria-atomic="true">
  <div class="hash-box">
    <h2>Vorgegebener Hash</h2>
    <div id="expected-hash" aria-label="Vorgegebener Hash"></div>
    <canvas id="expected-canvas" width="128" height="128" aria-hidden="true"></canvas>
  </div>
  <div class="hash-box">
    <h2>Berechneter Hash</h2>
    <div id="computed-hash" aria-label="Berechneter Hash"></div>
    <canvas id="computed-canvas" width="128" height="128" aria-hidden="true"></canvas>
  </div>
</div>

<a id="download-link" download>üì• Datei speichern</a>

<script>
  async function getSHA256(buffer) {
    const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }

  /**
   * Zeichnet die Bits des SHA-256 Hashes als 16x16 Pixel Schwarzwei√ü-Bitmap.
   * 1 Bit = wei√ü, 0 Bit = schwarz, skaliert um Faktor 8
   */
  function drawHashBits(hashHex, canvasId) {
    const ctx = document.getElementById(canvasId).getContext("2d");
    const zoom = 8;
    const size = 16;
    const canvas = ctx.canvas;
    canvas.width = size * zoom;
    canvas.height = size * zoom;

    // Aus Hex-String jeden einzelnen Bit-Wert extrahieren
    // Jeder Hex-Char = 4 Bits
    const bits = [];
    for (let i = 0; i < hashHex.length; i++) {
      const nibble = parseInt(hashHex[i], 16);
      for (let b = 3; b >= 0; b--) {
        bits.push((nibble >> b) & 1);
      }
    }

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Zeichne Pixel: wei√ü f√ºr 1, schwarz f√ºr 0
    for (let y = 0; y < size; y++) {
      for (let x = 0; x < size; x++) {
        const bit = bits[y * size + x];
        ctx.fillStyle = bit ? "#fff" : "#000";
        ctx.fillRect(x * zoom, y * zoom, zoom, zoom);
      }
    }
  }

  function getQueryParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  (async () => {
    const url = getQueryParam("url");
    const expectedHashRaw = getQueryParam("hash") || "";
    const expectedHash = expectedHashRaw.toLowerCase();

    if (!url || !expectedHash || expectedHash.length !== 64 || !/^[0-9a-f]{64}$/.test(expectedHash)) {
      document.getElementById("status").textContent = "‚ö†Ô∏è Bitte g√ºltige Parameter ?url=... & ?hash=64 hex Zeichen angeben.";
      document.getElementById("progress").style.display = "none";
      return;
    }

    document.getElementById("status").textContent = "‚è≥ Datei wird geladen...";

    try {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error("Fehler beim Laden der Datei: " + response.status + " " + response.statusText);
      }

      const contentLength = response.headers.get("content-length");
      const total = contentLength ? parseInt(contentLength, 10) : 0;
      const reader = response.body.getReader();

      let received = 0;
      let chunks = [];

      while(true) {
        const {done, value} = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.length;

        if (total) {
          const percent = Math.floor((received / total) * 100);
          document.getElementById("bar").style.width = percent + "%";
        }
      }

      const fileBlob = new Blob(chunks);
      const arrayBuffer = await fileBlob.arrayBuffer();
      const computedHash = await getSHA256(arrayBuffer);

      const match = computedHash === expectedHash;
      document.getElementById("status").textContent = match
        ? "‚úÖ Hash stimmt √ºberein."
        : "‚ùå Hash stimmt NICHT √ºberein.";

      document.getElementById("expected-hash").textContent = expectedHash;
      document.getElementById("computed-hash").textContent = computedHash;

      drawHashBits(expectedHash, "expected-canvas");
      drawHashBits(computedHash, "computed-canvas");

      const resultsDiv = document.getElementById("results");
      resultsDiv.style.display = "flex";

      // Download-Link anzeigen
      const dl = document.getElementById("download-link");
      dl.href = URL.createObjectURL(fileBlob);
      dl.download = url.split("/").pop() || "download.file";
      dl.style.display = "inline-block";
      dl.textContent = "üì• Datei speichern (" + dl.download + ")";

      // Progress-Bar nach Ladeende auf 100%
      document.getElementById("bar").style.width = "100%";

    } catch (e) {
      document.getElementById("status").textContent = "‚ö†Ô∏è Fehler: " + e.message;
      document.getElementById("progress").style.display = "none";
    }
  })();
</script>

</body>
</html>
