<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Demo Symmetrische Verschlüsselung</title>
<style>
  /* Basis-Reset & Typografie */
  body {
    margin: 0;
    padding: 1.5rem 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    color: #222;
    background: #fafafa;
  }
  main {
    max-width: 700px;
    margin: 0 auto;
    background: white;
    padding: 2rem;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
  }
  header h1 {
    font-size: 2rem;
    margin-bottom: 0.2em;
    color: #004080;
  }
  header .meta {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 1.5rem;
    font-style: italic;
  }
  label {
    display: block;
    margin-top: 1em;
    font-weight: bold;
  }
  input[type="text"],
  textarea {
    width: 100%;
    padding: 0.5em;
    font-family: monospace;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }
  textarea {
    resize: vertical;
    min-height: 4em;
  }
  .output {
    background-color: #f0f8ff;
    border: 1px solid #0a64ad;
    color: #004080;
    padding: 0.5em;
    font-family: monospace;
    white-space: pre-wrap;
    border-radius: 4px;
    position: relative;
  }
  .output.stale {
    background-color: #fff0f0;
    border-color: #cc0000;
    color: #990000;
  }
  button.copy-btn {
    margin-top: 0.3em;
    background-color: #004080;
    color: white;
    border: none;
    padding: 0.3em 0.7em;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.9rem;
    float: right;
  }
  button.copy-btn:hover {
    background-color: #002850;
  }
  .field-wrapper {
    position: relative;
  }
  footer {
    text-align: center;
    font-size: 0.85rem;
    color: #999;
    margin-top: 3rem;
    padding-top: 1rem;
    border-top: 1px solid #ddd;
    font-family: monospace;
  }
  .warning {
    background-color: #fff0f0;
    border: 1px solid #cc0000;
    color: #990000;
    padding: 1em 1.2em;
    margin-bottom: 1.5rem;
    border-radius: 4px;
  }
  .warning strong {
    font-weight: 700;
  }
</style>
</head>
<body>
<header>
  <h1>Demo Symmetrische Verschlüsselung (WebCrypto)</h1>
  <p class="meta">Generiert von ChatGPT (GPT-4o) – 2025-09-22 – Version 1.0</p>
</header>
<main>
  <section class="warning">
    <strong>⚠️ Hinweis:</strong>  
    Dieses Tool ist ein Demo und nutzt automatisch generierten Code.  
    Schlüssel und Nachrichten sind Base64-codiert.  
    Verwende es nicht für sicherheitskritische Zwecke ohne Prüfung!
  </section>

  <label for="message">Nachricht (klartext):</label>
  <textarea id="message" placeholder="Gib hier deine Nachricht ein...">Hallo, Welt!</textarea>

  <label for="key">Schlüssel (Base64, 16 oder 32 Bytes):</label>
  <input type="text" id="key" placeholder="z.B. w7/Dv8O/woTDpMK+w5DCrA==" value="w7/Dv8O/woTDpMK+w5DCrA=="/>

  <div class="field-wrapper">
    <label for="hash">SHA-256 Hash der Nachricht (Base64):</label>
    <pre id="hash" class="output stale" aria-live="polite"></pre>
    <button class="copy-btn" data-target="hash" aria-label="Hash kopieren">Kopieren</button>
  </div>

  <div class="field-wrapper">
    <label for="ciphertext">Verschlüsselte Nachricht (Base64):</label>
    <pre id="ciphertext" class="output stale" aria-live="polite"></pre>
    <button class="copy-btn" data-target="ciphertext" aria-label="Verschlüsselten Text kopieren">Kopieren</button>
  </div>

  <div class="field-wrapper">
    <label for="keyout">Schlüssel (Base64):</label>
    <pre id="keyout" class="output stale" aria-live="polite"></pre>
    <button class="copy-btn" data-target="keyout" aria-label="Schlüssel kopieren">Kopieren</button>
  </div>

</main>
<footer>
  <p>Generated by KI-Tool – © 2025 – Version 1.0</p>
</footer>

<!--
  Generiert von ChatGPT (GPT-4o) – 2025-09-22 – Version 1.0
  Anweisung / Prompt:
  "Bitte baue ein Tool, das symmetrische Verschlüsselung mit WebCrypto ermöglicht,
  Eingabefelder für Nachricht und Schlüssel enthält, Ausgabe in Base64 macht,
  Kopier-Buttons bei Schlüssel, Hash und Ciphertext einfügt,
  und AIREADME-konforme Hinweise zeigt."
-->

<script>
(() => {
  const encoder = new TextEncoder();
  const decoder = new TextDecoder();

  // Elemente
  const messageEl = document.getElementById('message');
  const keyEl = document.getElementById('key');
  const hashEl = document.getElementById('hash');
  const ciphertextEl = document.getElementById('ciphertext');
  const keyoutEl = document.getElementById('keyout');
  const copyButtons = document.querySelectorAll('button.copy-btn');

  // Status für Aktualisierung
  let hashUpToDate = false;
  let cipherUpToDate = false;
  let keyUpToDate = false;

  function base64ToArrayBuffer(base64) {
    try {
      const binary = atob(base64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes.buffer;
    } catch {
      return null;
    }
  }

  function arrayBufferToBase64(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  }

  function setOutput(el, text, upToDate) {
    el.textContent = text;
    if(upToDate){
      el.classList.remove('stale');
    } else {
      el.classList.add('stale');
    }
  }

  async function updateAll() {
    const msg = messageEl.value;
    const keyBase64 = keyEl.value.trim();

    // Hash berechnen
    if (msg.length > 0) {
      const msgBytes = encoder.encode(msg);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBytes);
      const hashBase64 = arrayBufferToBase64(hashBuffer);
      setOutput(hashEl, hashBase64, true);
      hashUpToDate = true;
    } else {
      setOutput(hashEl, '', false);
      hashUpToDate = false;
    }

    // Schlüssel aus Base64 importieren und ausgeben
    const keyBuffer = base64ToArrayBuffer(keyBase64);
    if (!keyBuffer || (keyBuffer.byteLength !== 16 && keyBuffer.byteLength !== 32)) {
      setOutput(keyoutEl, 'Ungültiger Schlüssel (muss 16 oder 32 Bytes Base64 sein)', false);
      keyUpToDate = false;
      setOutput(ciphertextEl, '', false);
      cipherUpToDate = false;
      return;
    }
    setOutput(keyoutEl, keyBase64, true);
    keyUpToDate = true;

    // Nachricht verschlüsseln (AES-GCM mit festem IV für Demo)
    try {
      const cryptoKey = await crypto.subtle.importKey(
        'raw',
        keyBuffer,
        'AES-GCM',
        false,
        ['encrypt']
      );
      const iv = new Uint8Array(12); // Null-IV (nicht sicher, nur Demo!)
      const encryptedBuffer = await crypto.subtle.encrypt(
        { name: 'AES-GCM', iv },
        cryptoKey,
        encoder.encode(msg)
      );
      const encryptedBase64 = arrayBufferToBase64(encryptedBuffer);
      setOutput(ciphertextEl, encryptedBase64, true);
      cipherUpToDate = true;
    } catch (e) {
      setOutput(ciphertextEl, 'Fehler bei Verschlüsselung: ' + e.message, false);
      cipherUpToDate = false;
    }
  }

  messageEl.addEventListener('input', () => {
    updateAll();
  });

  keyEl.addEventListener('input', () => {
    updateAll();
  });

  copyButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const targetId = btn.getAttribute('data-target');
      const targetEl = document.getElementById(targetId);
      if(!targetEl) return;
      const text = targetEl.textContent.trim();
      if(!text) return;
      navigator.clipboard.writeText(text).then(() => {
        btn.textContent = 'Kopiert!';
        setTimeout(() => {
          btn.textContent = 'Kopieren';
        }, 1500);
      }).catch(() => {
        alert('Kopieren fehlgeschlagen');
      });
    });
  });

  // Initiale Berechnung
  updateAll();
})();
</script>
</body>
</html>
